<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1">  1</a></span><span class="line"><span class="keyword">function</span> <span class="var type1" id="S2T1U3">xi</span> = dense_LM_kerl(<span class="var type1" id="S3T2U6">c1</span>, <span class="var type1" id="S4T2U7">c2</span>, <span class="var type1" id="S5T2U8">d1</span>, <span class="var type1" id="S6T2U9">d2</span>, <span class="var type1" id="S7T3U10">K1</span>, <span class="var type1" id="S8T3U11">K2</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2">  2</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3">  3</a></span><span class="line"><span class="var type0" id="S9T0U14">mode</span> = 1;</span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4">  4</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5">  5</a></span><span class="line"><span class="comment">% initialization</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6">  6</a></span><span class="line"><span class="var type0" id="S2T0U18">xi</span> = [0 0 0 0 0 0]';</span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7">  7</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8">  8</a></span><span class="line"><span class="comment">% pyramid levels</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9">  9</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S10T4U30">lvl</span> = 5:-1:1</span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10"> 10</a></span><span class="line">    <span class="comment">% get downscaled image, depth image, and K-matrix of down-scaled image.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11"> 11</a></span><span class="line">    <span class="message fatal" id="M1F1C">[<span class="var type0" id="S11T0U40">IRef</span>, <span class="var type0" id="S12T0U41">K1lvl</span>] = <span class="fcn" id="F2N3:B43">downscaleImage</span>(<span class="var type1" id="S3T2U44">c1</span>,<span class="var type1" id="S7T3U45">K1</span>,<span class="var type1" id="S10T4U46">lvl</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12"> 12</a></span><span class="line">    <span class="var type0" id="S14T0U49">I</span> = downscaleImage(<span class="var type0" id="S4T0U52">c2</span>,<span class="var type0" id="S8T0U53">K2</span>,<span class="var type0" id="S10T0U54">lvl</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13"> 13</a></span><span class="line">    [<span class="var type0" id="S15T0U58">DRef</span>] = downscaleDepth(<span class="var type0" id="S5T0U61">d1</span>,<span class="var type0" id="S10T0U62">lvl</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14"> 14</a></span><span class="line">	<span class="var type0" id="S17T0U65">lambda</span> = 0.01;</span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15"> 15</a></span><span class="line">	</span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16"> 16</a></span><span class="line">    <span class="comment">% just do at most 20 steps.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17"> 17</a></span><span class="line">    <span class="var type0" id="S18T0U69">errLast</span> = 1e10;</span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18"> 18</a></span><span class="line">    <span class="keyword">for</span> <span class="var type0" id="S19T0U73">i</span> = 1:50</span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19"> 19</a></span><span class="line">		</span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20"> 20</a></span><span class="line">		<span class="keyword">switch</span> <span class="var type0" id="S9T0U78">mode</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21"> 21</a></span><span class="line">			</span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22"> 22</a></span><span class="line">			<span class="keyword">case</span> 1</span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23"> 23</a></span><span class="line">				<span class="comment">% calculate Jacobian of residual function (Matrix of dim (width*height) x 6)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24"> 24</a></span><span class="line">				<span class="comment">%[Jac, residual] = deriveErrNumeric(IRef,DRef,I,xi,Klvl);   % ENABLE ME FOR NUMERIC DERIVATIVES</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25"> 25</a></span><span class="line">				[<span class="var type0" id="S20T0U84">Jac</span>, <span class="var type0" id="S21T0U85">residual</span>] = deriveErrAnalytic(<span class="var type0" id="S11T0U88">IRef</span>,<span class="var type0" id="S15T0U89">DRef</span>,<span class="var type0" id="S14T0U90">I</span>,<span class="var type0" id="S2T0U91">xi</span>,<span class="var type0" id="S12T0U92">K1lvl</span>);   <span class="comment">% ENABLE ME FOR ANALYTIC DERIVATIVES</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26"> 26</a></span><span class="line">				</span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27"> 27</a></span><span class="line">				<span class="comment">% just take the pixels that have no NaN (e.g. because</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28"> 28</a></span><span class="line">				<span class="comment">% out-of-bounds, or because the didnt have valid depth).</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29"> 29</a></span><span class="line">				<span class="var type0" id="S23T0U95">valid</span> = ~isnan(sum(<span class="var type0" id="S20T0U101">Jac</span>,2));</span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30"> 30</a></span><span class="line">				<span class="var type0" id="S26T0U105">residualTrim</span> = <span class="var type0" id="S21T0U107">residual</span>(<span class="var type0" id="S23T0U108">valid</span>,:);</span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31"> 31</a></span><span class="line">				<span class="var type0" id="S27T0U112">JacTrim</span> = <span class="var type0" id="S20T0U114">Jac</span>(<span class="var type0" id="S23T0U115">valid</span>,:);</span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32"> 32</a></span><span class="line">				</span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33"> 33</a></span><span class="line">				<span class="comment">% compute Huber Weights</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34"> 34</a></span><span class="line">				<span class="var type0" id="S28T0U119">huber</span> = ones(size(<span class="var type0" id="S21T0U124">residual</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35"> 35</a></span><span class="line">				<span class="var type0" id="S31T0U127">huberDelta</span> = 4/255;</span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36"> 36</a></span><span class="line">				<span class="var type0" id="S28T0U134">huber</span>(abs(<span class="var type0" id="S21T0U138">residual</span>) &gt; <span class="var type0" id="S31T0U139">huberDelta</span>) = <span class="var type0" id="S31T0U141">huberDelta</span> ./ abs(<span class="var type0" id="S21T0U145">residual</span>(abs(<span class="var type0" id="S21T0U149">residual</span>) &gt; <span class="var type0" id="S31T0U150">huberDelta</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37"> 37</a></span><span class="line">				<span class="var type0" id="S33T0U153">huberTrim</span> = <span class="var type0" id="S28T0U155">huber</span>(<span class="var type0" id="S23T0U156">valid</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38"> 38</a></span><span class="line">				</span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39"> 39</a></span><span class="line">				<span class="comment">% do LM</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40"> 40</a></span><span class="line">				<span class="var type0" id="S34T0U159">H</span> = (<span class="var type0" id="S27T0U163">JacTrim</span>' * (repmat(<span class="var type0" id="S33T0U168">huberTrim</span>,1,6) .* <span class="var type0" id="S27T0U171">JacTrim</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41"> 41</a></span><span class="line">				<span class="var type0" id="S36T0U174">upd</span> = - (<span class="var type0" id="S34T0U181">H</span> + <span class="var type0" id="S17T0U183">lambda</span> * diag(diag(<span class="var type0" id="S34T0U188">H</span>)))^-1 * <span class="var type0" id="S27T0U192">JacTrim</span>' * (<span class="var type0" id="S33T0U195">huberTrim</span> .* <span class="var type0" id="S26T0U196">residualTrim</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42"> 42</a></span><span class="line">				</span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43"> 43</a></span><span class="line">				<span class="comment">% MULTIPLY increment from left onto the current estimate.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44"> 44</a></span><span class="line">				<span class="var type0" id="S38T0U199">lastXi</span> = <span class="var type0" id="S2T0U200">xi</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45"> 45</a></span><span class="line"><span class="comment">% 				xi = se3Log(se3Exp(upd) * se3Exp(xi));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,46" id="srcline46"> 46</a></span><span class="line">				<span class="var type0" id="S2T0U203">xi</span> = <span class="var type0" id="S36T0U205">upd</span> + <span class="var type0" id="S2T0U206">xi</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,47" id="srcline47"> 47</a></span><span class="line">				</span></span>
<span class="srcline"><span class="lineno"><a href="1,48" id="srcline48"> 48</a></span><span class="line">				<span class="comment">% get mean and display</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,49" id="srcline49"> 49</a></span><span class="line">				<span class="var type0" id="S39T0U209">err</span> = mean((<span class="var type0" id="S33T0U215">huberTrim</span>.*<span class="var type0" id="S26T0U216">residualTrim</span>) .* <span class="var type0" id="S26T0U217">residualTrim</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,50" id="srcline50"> 50</a></span><span class="line">				</span></span>
<span class="srcline"><span class="lineno"><a href="1,51" id="srcline51"> 51</a></span><span class="line">						figure(6);</span></span>
<span class="srcline"><span class="lineno"><a href="1,52" id="srcline52"> 52</a></span><span class="line">						drawnow;</span></span>
<span class="srcline"><span class="lineno"><a href="1,53" id="srcline53"> 53</a></span><span class="line"><span class="comment">% 						saveas(gca, sprintf('results/err_%d%02d', 4-lvl, i), 'png');</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,54" id="srcline54"> 54</a></span><span class="line">				</span></span>
<span class="srcline"><span class="lineno"><a href="1,55" id="srcline55"> 55</a></span><span class="line"><span class="comment">% 						figure(7);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,56" id="srcline56"> 56</a></span><span class="line"><span class="comment">% 						saveas(gca, sprintf('warp_%d%02d', 4-lvl, i), 'png');</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,57" id="srcline57"> 57</a></span><span class="line">				</span></span>
<span class="srcline"><span class="lineno"><a href="1,58" id="srcline58"> 58</a></span><span class="line">				<span class="comment">% break if no improvement</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,59" id="srcline59"> 59</a></span><span class="line">				<span class="keyword">if</span>(<span class="var type0" id="S39T0U229">err</span> &gt;= <span class="var type0" id="S18T0U230">errLast</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,60" id="srcline60"> 60</a></span><span class="line">					<span class="var type0" id="S17T0U233">lambda</span> = <span class="var type0" id="S17T0U235">lambda</span> * 5;</span></span>
<span class="srcline"><span class="lineno"><a href="1,61" id="srcline61"> 61</a></span><span class="line">					<span class="var type0" id="S2T0U239">xi</span> = <span class="var type0" id="S38T0U240">lastXi</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,62" id="srcline62"> 62</a></span><span class="line">					</span></span>
<span class="srcline"><span class="lineno"><a href="1,63" id="srcline63"> 63</a></span><span class="line">					<span class="keyword">if</span>(<span class="var type0" id="S17T0U245">lambda</span> &gt; 5)</span></span>
<span class="srcline"><span class="lineno"><a href="1,64" id="srcline64"> 64</a></span><span class="line">						<span class="keyword">break</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,65" id="srcline65"> 65</a></span><span class="line">					<span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,66" id="srcline66"> 66</a></span><span class="line">				<span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,67" id="srcline67"> 67</a></span><span class="line">					<span class="var type0" id="S17T0U251">lambda</span> = <span class="var type0" id="S17T0U253">lambda</span> /1.5;</span></span>
<span class="srcline"><span class="lineno"><a href="1,68" id="srcline68"> 68</a></span><span class="line">				<span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,69" id="srcline69"> 69</a></span><span class="line">				<span class="var type0" id="S18T0U257">errLast</span> = <span class="var type0" id="S39T0U258">err</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,70" id="srcline70"> 70</a></span><span class="line">		</span></span>
<span class="srcline"><span class="lineno"><a href="1,71" id="srcline71"> 71</a></span><span class="line">			<span class="keyword">case</span> 2</span></span>
<span class="srcline"><span class="lineno"><a href="1,72" id="srcline72"> 72</a></span><span class="line">				<span class="comment">% calculate Jacobian of residual function (Matrix of dim (width*height) x 6)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,73" id="srcline73"> 73</a></span><span class="line">				<span class="comment">%[Jac, residual] = deriveErrNumeric(IRef,DRef,I,xi,Klvl);   % ENABLE ME FOR NUMERIC DERIVATIVES</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,74" id="srcline74"> 74</a></span><span class="line">				[<span class="var type0" id="S20T0U264">Jac</span>, <span class="var type0" id="S21T0U265">residual</span>] = deriveErrAnalytic(<span class="var type0" id="S11T0U268">IRef</span>,<span class="var type0" id="S15T0U269">DRef</span>,<span class="var type0" id="S14T0U270">I</span>,<span class="var type0" id="S2T0U271">xi</span>,<span class="var type0" id="S12T0U272">K1lvl</span>);   <span class="comment">% ENABLE ME FOR ANALYTIC DERIVATIVES</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,75" id="srcline75"> 75</a></span><span class="line">				</span></span>
<span class="srcline"><span class="lineno"><a href="1,76" id="srcline76"> 76</a></span><span class="line">				<span class="comment">% just take the pixels that have no NaN (e.g. because</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,77" id="srcline77"> 77</a></span><span class="line">				<span class="comment">% out-of-bounds, or because the didnt have valid depth).</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,78" id="srcline78"> 78</a></span><span class="line">				<span class="var type0" id="S23T0U275">valid</span> = ~isnan(sum(<span class="var type0" id="S20T0U281">Jac</span>,2));</span></span>
<span class="srcline"><span class="lineno"><a href="1,79" id="srcline79"> 79</a></span><span class="line">				<span class="var type0" id="S26T0U285">residualTrim</span> = <span class="var type0" id="S21T0U287">residual</span>(<span class="var type0" id="S23T0U288">valid</span>,:);</span></span>
<span class="srcline"><span class="lineno"><a href="1,80" id="srcline80"> 80</a></span><span class="line">				<span class="var type0" id="S27T0U292">JacTrim</span> = <span class="var type0" id="S20T0U294">Jac</span>(<span class="var type0" id="S23T0U295">valid</span>,:);</span></span>
<span class="srcline"><span class="lineno"><a href="1,81" id="srcline81"> 81</a></span><span class="line">				</span></span>
<span class="srcline"><span class="lineno"><a href="1,82" id="srcline82"> 82</a></span><span class="line">				<span class="comment">% do Gauss-Newton step</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,83" id="srcline83"> 83</a></span><span class="line">				<span class="var type0" id="S36T0U299">upd</span> = - (<span class="var type0" id="S27T0U307">JacTrim</span>' * <span class="var type0" id="S27T0U308">JacTrim</span>)^-1 * <span class="var type0" id="S27T0U312">JacTrim</span>' * <span class="var type0" id="S26T0U313">residualTrim</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,84" id="srcline84"> 84</a></span><span class="line">				</span></span>
<span class="srcline"><span class="lineno"><a href="1,85" id="srcline85"> 85</a></span><span class="line">				<span class="comment">% MULTIPLY increment from left onto the current estimate.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,86" id="srcline86"> 86</a></span><span class="line">				<span class="comment">% 		xi = xi + upd;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,87" id="srcline87"> 87</a></span><span class="line"><span class="comment">% 				xi = se3Log(se3Exp(upd) * se3Exp(xi));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,88" id="srcline88"> 88</a></span><span class="line">				<span class="var type0" id="S2T0U316">xi</span> = <span class="var type0" id="S36T0U318">upd</span> + <span class="var type0" id="S2T0U319">xi</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,89" id="srcline89"> 89</a></span><span class="line">				</span></span>
<span class="srcline"><span class="lineno"><a href="1,90" id="srcline90"> 90</a></span><span class="line">				<span class="comment">% get mean and display</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,91" id="srcline91"> 91</a></span><span class="line">				<span class="var type0" id="S39T0U322">err</span> = mean(<span class="var type0" id="S26T0U326">residualTrim</span> .* <span class="var type0" id="S26T0U327">residualTrim</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,92" id="srcline92"> 92</a></span><span class="line">				</span></span>
<span class="srcline"><span class="lineno"><a href="1,93" id="srcline93"> 93</a></span><span class="line">				</span></span>
<span class="srcline"><span class="lineno"><a href="1,94" id="srcline94"> 94</a></span><span class="line">				<span class="comment">%calcErr(c1,d1,c2,xi,K);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,95" id="srcline95"> 95</a></span><span class="line">				</span></span>
<span class="srcline"><span class="lineno"><a href="1,96" id="srcline96"> 96</a></span><span class="line">				<span class="comment">% break if no improvement</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,97" id="srcline97"> 97</a></span><span class="line">				<span class="keyword">if</span>(<span class="var type0" id="S39T0U333">err</span> / <span class="var type0" id="S18T0U334">errLast</span> &gt; 0.999)</span></span>
<span class="srcline"><span class="lineno"><a href="1,98" id="srcline98"> 98</a></span><span class="line">					<span class="keyword">break</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,99" id="srcline99"> 99</a></span><span class="line">				<span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,100" id="srcline100">100</a></span><span class="line">				<span class="var type0" id="S18T0U339">errLast</span> = <span class="var type0" id="S39T0U340">err</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,101" id="srcline101">101</a></span><span class="line">		<span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,102" id="srcline102">102</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,103" id="srcline103">103</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,104" id="srcline104">104</a></span><span class="line"><span class="keyword"><span class="keyword">end</span></span></span></span>
</pre>
